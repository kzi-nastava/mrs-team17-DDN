<div class="content">
  <div class="card">
    <div class="card-title">Ride status</div>

    <div class="toolbar">
      <input
        class="input"
        [(ngModel)]="query"
        (keyup.enter)="reload()"
        placeholder="Search driver (name / email)..."
        aria-label="Search by driver name or email"
      />
      <div class="toolbar-actions">
        <button
          class="btn btn-ghost"
          *ngIf="query.trim().length > 0"
          (click)="clearQuery()"
          [disabled]="loading"
        >
          Clear
        </button>
        <button class="btn" (click)="reload()" [disabled]="loading">
          {{ loading ? 'Searching...' : 'Search' }}
        </button>
      </div>
    </div>

    <div class="list-meta" *ngIf="!loading && !error">
      <span>{{ rows.length }} active ride{{ rows.length === 1 ? '' : 's' }}</span>
      <span *ngIf="lastUpdatedAt">Updated {{ lastUpdatedAt | date:'shortTime' }}</span>
    </div>

    <div *ngIf="loading" class="hint">Loading...</div>
    <div *ngIf="!loading && error" class="hint">{{ error }}</div>

    <div class="list" *ngIf="!loading && !error">
      <div class="row" *ngFor="let r of rows">
        <div
          class="item clickable"
          (click)="toggleDetails(r)"
          (keydown)="onRowKeydown($event, r)"
          tabindex="0"
          role="button"
          [attr.aria-expanded]="expandedRideId === r.rideId"
          [class.expanded]="expandedRideId === r.rideId"
        >
          <div class="left">
            <div class="id-line">
              <div class="id">Ride #{{ r.rideId }}</div>
              <span class="status-badge" [ngClass]="statusClass(r.status)">
                {{ statusLabel(r.status) }}
              </span>
            </div>
            <div class="user">
              Driver:
              {{ (r.driverFirstName || '') + ' ' + (r.driverLastName || '') }}
              ({{ r.driverEmail || 'no email' }})
            </div>
          </div>

          <div class="right">
            <div class="time">{{ formatStartedAt(r.startedAt) }}</div>
            <div class="time muted-line">Live position available</div>
          </div>
        </div>

        <div class="details" *ngIf="expandedRideId === r.rideId">
          <div class="details-head">
            <div class="pill">
              <span class="pill-k">Status</span>
              <span class="status-badge" [ngClass]="statusClass(details?.status)">
                {{ statusLabel(details?.status) }}
              </span>
            </div>

            <div class="meta">
              <div class="meta-item">
                <div class="k">ETA</div>
                <div class="v">{{ etaLabel(details?.etaMinutes) }}</div>
              </div>
              <div class="meta-item">
                <div class="k">Distance</div>
                <div class="v">{{ distanceLabel(details?.distanceKm) }}</div>
              </div>
            </div>
          </div>

          <div *ngIf="detailsLoading" class="hint">Loading details...</div>
          <div *ngIf="!detailsLoading && detailsError" class="hint">{{ detailsError }}</div>

          <div class="details-body" *ngIf="!detailsLoading && !detailsError">
            <div class="mini-map-wrap">
              <div class="mini-map" [id]="'mini-map-' + r.rideId"></div>
              <div class="map-caption">Live ride map (car, route and checkpoints)</div>
            </div>

            <div class="grid">
              <div class="kv">
                <div class="k">Route points</div>
                <div class="v">{{ routePointCount(details?.route) }}</div>
              </div>

              <div class="kv">
                <div class="k">Checkpoints</div>
                <div class="v">{{ details?.checkpoints?.length || 0 }}</div>
              </div>

              <div class="kv full">
                <div class="k">Checkpoint list</div>
                <div class="v">
                  <div *ngIf="(details?.checkpoints?.length || 0) === 0" class="muted">
                    No checkpoints on this ride.
                  </div>
                  <div class="cp" *ngFor="let cp of (details?.checkpoints || [])">
                    <span class="cp-ord">#{{ cp.order }}</span>
                    <span class="cp-addr">{{ cp.address || ('Checkpoint #' + cp.order) }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <div *ngIf="rows.length === 0" class="hint">No active rides</div>
    </div>
  </div>
</div>
